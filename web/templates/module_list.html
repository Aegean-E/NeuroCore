<h2 class="text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 mb-2">Loaded Modules</h2>
<div id="sortable-module-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-1 px-2">
    {% if not modules %}
    <p class="text-slate-600 text-sm italic px-4">No modules loaded</p>
    {% else %}
    {% for module in modules %}
    <div data-module-id="{{ module.id }}" class="w-full rounded-lg hover:bg-slate-800 text-slate-300 hover:text-white transition-all text-sm flex items-center group cursor-grab active:cursor-grabbing">
        <button hx-get="/modules/{{ module.id }}/details"
                hx-target="#module-content"
                hx-swap="innerHTML"
                class="w-full text-left px-3 py-2 flex items-center">
            <span class="w-2 h-2 rounded-full {{ 'bg-red-500' if module.load_error and module.enabled else ('bg-emerald-500' if module.enabled else 'bg-slate-600') }} mr-3 group-hover:scale-125 transition-transform"></span>
            {{ module.name }}
        </button>
    </div>
    {% endfor %}
    {% endif %}
</div>

<script>
(function() {
    // This function is designed to be idempotent, so it can be called multiple times
    // by HTMX after content swaps without re-initializing.
    const list = document.getElementById('sortable-module-list');
    if (list && !list.dataset.sortable) {
        list.dataset.sortable = 'true';
        new Sortable(list, {
            animation: 150,
            ghostClass: 'bg-slate-800/50',
            onEnd: function (evt) {
                const order = Array.from(evt.to.children).map(child => child.dataset.moduleId);
                htmx.ajax('POST', '/modules/reorder', {
                    values: { order: order.join(',') },
                    swap: 'none' // We don't need to swap content, just trigger events
                });
            }
        });
    }
})();
</script>