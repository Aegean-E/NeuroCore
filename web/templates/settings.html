<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - NeuroCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@2.0.2"></script>
    <!-- Sortable.js for module reordering -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col font-sans">
    
    {% include 'navbar.html' %}

    <main class="flex-grow container mx-auto p-6 flex gap-6 h-[calc(100vh-80px)] overflow-hidden">
        
        <!-- Settings Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-slate-950/50 rounded-xl border border-slate-800 p-4 flex flex-col gap-2">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2">Configuration</h3>
            <a href="#" onclick="switchTab(event, 'general')" class="settings-nav-link block px-3 py-2 rounded-lg bg-slate-800 text-white text-sm font-medium transition-all">General</a>
            <a href="#" onclick="switchTab(event, 'modules')" class="settings-nav-link block px-3 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white text-sm font-medium transition-all">Modules</a>
            <div id="settings-modules-nav" hx-get="/settings/modules-nav" hx-trigger="modulesChanged from:body">
                {% include 'settings_modules_nav.html' %}
            </div>
        </aside>

        <!-- Settings Content -->
        <div class="flex-grow bg-slate-950/50 rounded-xl border border-slate-800 shadow-2xl relative overflow-hidden flex flex-col">
            
            <!-- General Section -->
            <div id="general" class="settings-tab flex flex-col h-full relative">
                <div class="overflow-y-auto custom-scrollbar flex-grow p-8 scroll-smooth pb-24" id="settings-scroll-container">
                    <form id="general-settings-form" hx-post="/settings/save" hx-swap="none" class="max-w-3xl">
                        <div class="mb-6">
                            <h2 class="text-xl font-bold text-white">General Settings</h2>
                            <p class="text-sm text-slate-500">System-wide configurations.</p>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">System Time</div>
                                <div class="text-sm text-slate-300 font-mono" hx-get="/system-time" hx-trigger="every 1s" hx-swap="innerHTML">{{ system_time }}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                                    <div class="text-xs text-slate-500 uppercase font-bold mb-1">Environment</div>
                                    <div class="text-sm text-slate-300 font-mono truncate" title="{{ system_info.platform }}">{{ system_info.platform }}</div>
                                </div>
                                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                                    <div class="text-xs text-slate-500 uppercase font-bold mb-1">Python Version</div>
                                    <div class="text-sm text-slate-300 font-mono">{{ system_info.python_version }}</div>
                                </div>
                            </div>

                            <div class="border-t border-slate-800 pt-6">
                                <h3 class="text-lg font-bold text-white mb-4">Interface Preferences</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <div class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" name="ui_wide_mode" class="sr-only peer" {% if settings.ui_wide_mode %}checked{% endif %}>
                                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </div>
                                            <span class="text-sm font-medium text-slate-400">Wide Layout</span>
                                        </label>
                                        <input type="hidden" name="save_ui_wide_mode" value="1">
                                        <p class="text-xs text-slate-600 mt-2 pl-14">Expands the main content area to fill the screen width.</p>
                                    </div>
                                    <div>
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <div class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" name="ui_show_footer" class="sr-only peer" {% if settings.ui_show_footer %}checked{% endif %}>
                                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </div>
                                            <span class="text-sm font-medium text-slate-400">Show Footer</span>
                                        </label>
                                        <input type="hidden" name="save_ui_show_footer" value="1">
                                    </div>
                                </div>
                            </div>

                            <div class="border-t border-slate-800 pt-6">
                                <h3 class="text-lg font-bold text-white mb-4">System Debugging</h3>
                                <div>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <div class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" name="debug_mode" class="sr-only peer" {% if settings.debug_mode %}checked{% endif %}>
                                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        </div>
                                        <span class="text-sm font-medium text-slate-400">Enable Debug Mode</span>
                                    </label>
                                    <input type="hidden" name="save_debug_mode" value="1">
                                    <p class="text-xs text-slate-600 mt-2 pl-14">Enables detailed logging of AI Flow execution and shows the Debug tab.</p>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <div class="mt-8 border-t border-slate-800 pt-6">
                        <h3 class="text-lg font-bold text-white mb-4">Data Management</h3>
                        <div class="bg-slate-900 rounded-xl border border-slate-800 p-4 flex items-center justify-between mb-4">
                            <div>
                                <h4 class="font-semibold text-slate-300">Flows Backup</h4>
                                <p class="text-xs text-slate-500 mt-1">Export your flows to JSON or restore from a backup.</p>
                            </div>
                            <div class="flex space-x-2">
                                <form id="import-flows-form" hx-post="/settings/import/flows" hx-encoding="multipart/form-data" hx-swap="none" class="hidden">
                                    <input type="file" name="file" accept=".json" onchange="if(confirm('This will overwrite all current flows. Continue?')) this.form.requestSubmit(); this.value=''">
                                </form>
                                <button onclick="document.querySelector('#import-flows-form input').click()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all border border-slate-700">
                                    Import
                                </button>
                                <a href="/settings/export/flows" target="_blank" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all border border-slate-700">
                                    Export
                                </a>
                            </div>
                        </div>

                        <div class="bg-slate-900 rounded-xl border border-slate-800 p-4 flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-300">Configuration Backup</h4>
                                <p class="text-xs text-slate-500 mt-1">Save your API keys and preferences.</p>
                            </div>
                            <div class="flex space-x-2">
                                <form id="import-config-form" hx-post="/settings/import/config" hx-encoding="multipart/form-data" hx-swap="none" class="hidden">
                                    <input type="file" name="file" accept=".json" onchange="if(confirm('This will overwrite current settings. Continue?')) this.form.requestSubmit(); this.value=''">
                                </form>
                                <button onclick="document.querySelector('#import-config-form input').click()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all border border-slate-700">
                                    Import
                                </button>
                                <a href="/settings/export/config" target="_blank" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all border border-slate-700">
                                    Export
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 border-t border-slate-800 pt-6">
                        <div class="bg-red-950/20 rounded-xl border border-red-900/30 p-4 flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-red-400">Factory Reset</h4>
                                <p class="text-xs text-red-300/70 mt-1">Reset all settings to default values. Data is preserved.</p>
                            </div>
                            <button onclick="openResetModal()"
                                    class="bg-red-900/30 hover:bg-red-900/50 text-red-400 px-4 py-2 rounded-lg text-sm font-bold transition-all border border-red-900/50">
                                Reset Settings
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Sticky Footer for General -->
                <div class="p-6 border-t border-slate-800 bg-slate-950/80 backdrop-blur absolute bottom-0 left-0 right-0 flex justify-end">
                    <button onclick="document.getElementById('general-settings-form').requestSubmit()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl text-sm font-semibold transition-all shadow-lg shadow-blue-500/20">
                        Save Settings
                    </button>
                </div>
            </div>

            <!-- Modules Section -->
            <div id="modules" class="settings-tab hidden flex h-full">
                <!-- Module List Sidebar -->
                <aside class="w-64 flex-shrink-0 border-r border-slate-800 bg-slate-900/30 flex flex-col">
                     <div id="module-list-container" hx-get="/modules/list" hx-trigger="load, modulesChanged from:body" class="flex-grow overflow-y-auto custom-scrollbar py-3"></div>
                </aside>

                <!-- Module Details Content -->
                <section class="flex-grow relative bg-slate-950/30">
                    <div id="module-content" class="absolute inset-0 p-6 overflow-y-auto custom-scrollbar">
                        <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50">
                            <svg class="w-16 h-16 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                            <p class="text-slate-500">Select a module to configure</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Tools Section -->
            <div id="tools" class="settings-tab hidden flex flex-col h-full relative">
                <div class="flex-grow overflow-y-auto custom-scrollbar" hx-get="/tools/gui" hx-trigger="revealed">
                    <div class="flex items-center justify-center h-full">
                        <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function switchTab(event, tabId) {
            event.preventDefault();
            const element = event.currentTarget;
            
            document.querySelectorAll('.settings-nav-link').forEach(el => {
                el.classList.remove('bg-slate-800', 'text-white');
                el.classList.add('text-slate-400', 'hover:bg-slate-800', 'hover:text-white');
            });
            element.classList.remove('text-slate-400', 'hover:bg-slate-800', 'hover:text-white');
            element.classList.add('bg-slate-800', 'text-white');
            
            document.querySelectorAll('.settings-tab').forEach(el => {
                el.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
        }

        function openResetModal() {
            const modal = document.getElementById('reset-modal');
            const backdrop = document.getElementById('reset-modal-backdrop');
            const panel = document.getElementById('reset-modal-panel');

            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'scale-95');
                panel.classList.add('opacity-100', 'scale-100');
            });
        }

        function closeResetModal() {
            const modal = document.getElementById('reset-modal');
            const backdrop = document.getElementById('reset-modal-backdrop');
            const panel = document.getElementById('reset-modal-panel');

            backdrop.classList.add('opacity-0');
            panel.classList.remove('opacity-100', 'scale-100');
            panel.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }
    </script>

    <!-- Factory Reset Confirmation Modal -->
    <div id="reset-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm transition-opacity opacity-0" id="reset-modal-backdrop" onclick="closeResetModal()"></div>
        <div class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-800 text-left shadow-2xl transition-all scale-95 opacity-0 sm:w-full sm:max-w-md p-6" id="reset-modal-panel">
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900/30 text-red-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
                <div class="flex-grow">
                    <h3 class="text-lg font-semibold leading-6 text-white" id="modal-title">Factory Reset</h3>
                    <div class="mt-2">
                        <p class="text-sm text-slate-400">Are you sure you want to reset all settings to default values? This action cannot be undone.</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeResetModal()" class="rounded-xl px-4 py-2 text-sm font-semibold text-slate-300 hover:bg-slate-800 transition-colors">Cancel</button>
                <button hx-post="/settings/reset" 
                        hx-swap="none"
                        onclick="closeResetModal()"
                        class="rounded-xl bg-red-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 transition-colors">
                    Reset Settings
                </button>
            </div>
        </div>
    </div>

    <div id="main-footer" hx-get="/footer" hx-trigger="settingsChanged from:body" hx-swap="innerHTML">
        {% include 'footer.html' %}
    </div>

</body>
</html>
